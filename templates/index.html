<!DOCTYPE html>
<html>
<head>
    <title>ChunkMaster | Divide & Aprenda</title>
    {% load static %}
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <div class="container">
        <div class="app-header animate__animated animate__fadeIn">
            <h1>Chunk<span class="highlight">Master</span></h1>
            <p>Transforme temas complexos em <span class="chunk-text">chunks</span> digestíveis para facilitar seu aprendizado</p>
        </div>

        <div class="form-container animate__animated animate__fadeInUp">
            <form method="post">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label>O que você quer <span class="chunk-text">chunkar</span> hoje?</label>
                        <input type="text" name="tema" class="form-control" value="{{ tema }}" required placeholder="Ex: Física Quântica, Literatura Brasileira, Machine Learning...">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Número de <span class="chunk-text">chunks</span>:</label>
                        <input type="number" name="num_partes" class="form-control" value="{{ num_partes }}" min="2" max="22" required>
                        <small class="text-muted">Mínimo: 2, Máximo: 22</small>
                        <div id="parts-warning" style="display:none;" class="text-danger mt-1">
                            <strong>Nota:</strong> Muitos chunks podem levar mais tempo para gerar.
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn chunk-button" {% if quota_exceeded %}disabled title="API indisponível no momento"{% endif %}>
                    <span class="chunk-icon">⧉</span> Chunk!
                </button>
            </form>
        </div>
        
        {% if error %}
        <div class="alert alert-danger">
            <h4 class="alert-heading">Erro:</h4>
            <p>{{ error }}</p>
            {% if quota_exceeded %}
            <hr>
            <div class="quota-info">
                <h5 style="color: #ff6f00;">O que isso significa?</h5>
                <p>A API do Google Gemini tem limites de uso gratuito:</p>
                <ul>
                    <li>60 solicitações por minuto</li>
                    <li>Número limitado de solicitações por dia</li>
                </ul>
                <p>Opções para resolver:</p>
                <ol>
                    <li>Aguardar alguns minutos e tentar novamente</li>
                    <li>Obter uma nova chave de API em <a href="https://ai.google.dev/" target="_blank">Google AI Studio</a></li>
                    <li>Atualizar para um plano pago no Google Cloud</li>
                </ol>
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        {% if html_result %}
        <div class="result-container">
            <!-- Índice de navegação -->
            <div class="toc card mb-4" id="table-of-contents">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="toc-title">Navegue pelos <span class="chunk-text">chunks</span></div>
                    <button class="btn btn-sm btn-outline-secondary toc-toggle" onclick="toggleToc()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots" viewBox="0 0 16 16">
                            <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                        </svg>
                        <span id="toc-toggle-text">Ocultar</span>
                    </button>
                </div>
                <div class="card-body toc-container">
                    <!-- Será preenchido via JavaScript -->
                </div>
            </div>
            
            <!-- Conteúdo HTML que será processado pelo JS -->
            <div id="html-content" style="display:none">{{ html_result|safe }}</div>
            
            <!-- Bootstrap Grid para Cards -->
            <div class="masonry-grid" id="cards-container">
                <!-- Os cards serão gerados via JavaScript -->
            </div>
            
            <!-- Fallback content container -->
            <div id="fallback-content" class="fallback-content card">
                <div class="card-header">
                    <h3>Seu conteúdo <span class="chunk-text">chunkado</span>:</h3>
                </div>
                <div class="card-body formatted-content-visible">
                    {{ html_result|safe }}
                </div>
                <div class="card-footer">
                    <button class="btn btn-outline-secondary expand-button" onclick="toggleFallbackContent()">Expandir/Recolher</button>
                </div>
            </div>
        </div>
        {% endif %}
        
        <footer class="site-footer">
            <p>© 2024 ChunkMaster | Simplificando o aprendizado através de chunks inteligentes</p>
        </footer>
    </div>
    
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Opcional: Masonry para layout de grade dinâmica -->
    <script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script>
    
    <script>
    // Mostrar aviso para muitas partes
    document.querySelector('input[name="num_partes"]').addEventListener('change', function() {
        var numPartes = parseInt(this.value);
        var warning = document.getElementById('parts-warning');
        
        if (numPartes > 10) {
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    });
    
    // Função para alternar a visibilidade do índice
    function toggleToc() {
        const tocContainer = document.querySelector('#table-of-contents .toc-container');
        const tocToggleText = document.getElementById('toc-toggle-text');
        
        if (tocContainer.style.display === 'none') {
            tocContainer.style.display = 'block';
            tocToggleText.textContent = 'Ocultar';
        } else {
            tocContainer.style.display = 'none';
            tocToggleText.textContent = 'Mostrar';
        }
    }
    
    // Função para expandir/recolher cards
    function toggleCardExpansion(cardId) {
        const card = document.getElementById(cardId);
        const cardBody = card.querySelector('.card-body');
        const expandBtn = card.querySelector('.expand-button');
        
        if (cardBody.classList.contains('collapsed')) {
            cardBody.classList.remove('collapsed');
            expandBtn.textContent = 'Mostrar menos';
        } else {
            cardBody.classList.add('collapsed');
            expandBtn.textContent = 'Mostrar mais';
        }
        
        // Atualizar layout do Masonry
        if (window.msnry) {
            setTimeout(() => window.msnry.layout(), 100);
        }
    }
    
    // Função para expandir e recolher o conteúdo de fallback
    function toggleFallbackContent() {
        var content = document.querySelector('.formatted-content-visible');
        if (content.style.maxHeight === 'none') {
            content.style.maxHeight = '500px';
        } else {
            content.style.maxHeight = 'none';
        }
    }
    
    {% if html_result %}
    // Verificar se o conteúdo foi carregado corretamente e mostrar fallback se necessário
    document.addEventListener('DOMContentLoaded', function() {
        // Mostrar o fallback diretamente
        document.getElementById('fallback-content').style.display = 'block';
        
        // Adicionar um timeout para processar os cards em segundo plano
        setTimeout(function() {
            try {
                const htmlContent = document.getElementById('html-content');
                
                // Criar um elemento temporário com o conteúdo HTML
                const tempDiv = document.createElement('div');
                tempDiv.className = 'formatted-content';
                tempDiv.innerHTML = htmlContent.innerHTML;
                document.body.appendChild(tempDiv);
                
                // Agora que temos o elemento formatado, podemos tentar gerar os cards
                parseContentIntoCards();
                createTableOfContents();
                
                // Verificar se os cards foram criados
                if (document.querySelectorAll('.chunk-card').length > 0) {
                    // Cards criados com sucesso, podemos esconder o fallback
                    document.getElementById('fallback-content').style.display = 'none';
                    
                    // Inicializar Masonry após os cards serem criados
                    initMasonry();
                }
                
                // Remover o elemento temporário
                setTimeout(() => document.body.removeChild(tempDiv), 100);
                
            } catch (error) {
                console.error("Erro ao processar conteúdo:", error);
            }
        }, 500);
    });
    
    function parseContentIntoCards() {
        const content = document.querySelector('.formatted-content');
        
        if (!content || !content.innerHTML) {
            return;
        }
        
        const cardsContainer = document.getElementById('cards-container');
        
        // Extrair o título principal (h1)
        const mainTitle = content.querySelector('h1');
        let mainTitleText = mainTitle ? mainTitle.textContent : 'ChunkMaster';
        
        // Encontrar todas as seções h2
        const sections = content.querySelectorAll('h2');
        
        // Primeiro, criar o card de introdução para Contextualização
        let introHtml = '';
        let introSections = [];
        
        // Capturar o conteúdo antes da primeira parte, que deve incluir Contextualização e Objetivos
        let capturedIntroduction = false;
        
        for (let i = 0; i < sections.length; i++) {
            const section = sections[i];
            
            // Verificar se esta seção faz parte da introdução (antes de começar as partes)
            if (!section.textContent.toLowerCase().includes('parte')) {
                // Adicionar o título h2 e todo seu conteúdo subsequente até o próximo h2
                introSections.push(section);
                introHtml += section.outerHTML;
                
                let nextNode = section.nextElementSibling;
                while (nextNode && nextNode.tagName !== 'H2') {
                    introHtml += nextNode.outerHTML;
                    nextNode = nextNode.nextElementSibling;
                }
                
                capturedIntroduction = true;
            } else {
                // Quando chegamos à primeira parte, paramos de capturar a introdução
                break;
            }
        }
        
        // Se não encontramos nenhuma seção introdutória mas temos conteúdo antes da primeira parte
        // (caso o modelo não tenha usado h2 para Contextualização), capturar manualmente
        if (!capturedIntroduction && mainTitle) {
            let nextNode = mainTitle.nextElementSibling;
            while (nextNode && !nextNode.textContent.toLowerCase().includes('parte')) {
                if (nextNode.tagName !== 'H2') {
                    introHtml += nextNode.outerHTML;
                }
                nextNode = nextNode.nextElementSibling;
            }
        }
        
        if (introHtml) {
            const introCard = document.createElement('div');
            introCard.className = 'chunk-card context-card';
            introCard.id = 'card-intro';
            introCard.innerHTML = `
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <h3 class="card-title mb-0">${mainTitleText}</h3>
                    </div>
                    <div class="card-body collapsed">
                        ${introHtml}
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-outline-info expand-button" onclick="toggleCardExpansion('card-intro')">Mostrar mais</button>
                    </div>
                </div>
            `;
            cardsContainer.appendChild(introCard);
        }
        
        // Encontrar e criar cards para cada parte
        let parts = [];
        let currentPart = null;
        
        for (let i = 0; i < sections.length; i++) {
            const section = sections[i];
            
            if (section.textContent.toLowerCase().includes('parte')) {
                if (currentPart) {
                    parts.push(currentPart);
                }
                
                // Iniciar uma nova parte
                currentPart = {
                    title: section.textContent,
                    content: '',
                    html: section.outerHTML,
                    size: 'medium' // Tamanho padrão
                };
                
                // Determinar o tamanho do card com base no conteúdo
                let nextNode = section.nextElementSibling;
                let contentLength = 0;
                
                while (nextNode && nextNode.tagName !== 'H2') {
                    contentLength += (nextNode.textContent || '').length;
                    nextNode = nextNode.nextElementSibling;
                }
                
                // Definir tamanho com base no comprimento do conteúdo
                if (contentLength > 1000) {
                    currentPart.size = 'large';
                } else if (contentLength < 400) {
                    currentPart.size = 'small';
                }
                
            } else if (section.textContent.toLowerCase().includes('conclusão')) {
                // Quando encontramos a conclusão, finalizamos a parte atual
                if (currentPart) {
                    parts.push(currentPart);
                }
                break;
            } else if (currentPart && !introSections.includes(section)) {
                // Adicione esta seção à parte atual se não for uma seção de introdução
                currentPart.html += section.outerHTML;
            }
            
            // Para a parte atual, adicione também os elementos que seguem até o próximo h2
            if (currentPart) {
                let nextNode = section.nextElementSibling;
                while (nextNode && nextNode.tagName !== 'H2') {
                    if (section.textContent.toLowerCase().includes('parte')) {
                        currentPart.html += nextNode.outerHTML;
                        
                        // Extrair objetivos e conceitos-chave
                        if (nextNode.innerHTML && nextNode.innerHTML.includes('<strong>Objetivo de Aprendizagem:</strong>')) {
                            currentPart.objective = nextNode.innerHTML.replace('<strong>Objetivo de Aprendizagem:</strong>', '').trim();
                        }
                        if (nextNode.innerHTML && nextNode.innerHTML.includes('<strong>Conceitos-chave:</strong>')) {
                            currentPart.concepts = nextNode.innerHTML.replace('<strong>Conceitos-chave:</strong>', '').trim();
                        }
                        if (nextNode.innerHTML && nextNode.innerHTML.includes('<strong>Pergunta de Reflexão:</strong>')) {
                            currentPart.question = nextNode.innerHTML.replace('<strong>Pergunta de Reflexão:</strong>', '').trim();
                        }
                    }
                    nextNode = nextNode.nextElementSibling;
                }
            }
        }
        
        // Adicionar a última parte se existir
        if (currentPart) {
            parts.push(currentPart);
        }
        
        // Criar os cards para cada parte com classes diferentes baseadas no tamanho
        parts.forEach((part, index) => {
            const partCard = document.createElement('div');
            
            // Definir classes baseadas no tamanho para grid layout
            let sizeClass;
            switch(part.size) {
                case 'large':
                    sizeClass = 'col-md-8 col-lg-6';
                    break;
                case 'small':
                    sizeClass = 'col-md-4 col-lg-3';
                    break;
                default: // medium
                    sizeClass = 'col-md-6 col-lg-4';
            }
            
            partCard.className = `chunk-card ${sizeClass}`;
            partCard.id = `card-part-${index + 1}`;
            
            // Extract badges (concepts) if they exist
            let badgesHtml = '';
            if (part.concepts) {
                const concepts = part.concepts.split(',').map(c => c.trim());
                badgesHtml = concepts.slice(0, 3).map(concept => 
                    `<span class="badge bg-secondary me-1">${concept}</span>`
                ).join('');
            }
            
            // Create reflection box if a question exists
            let reflectionHtml = '';
            if (part.question) {
                reflectionHtml = `
                    <div class="reflection-box mt-3 border-start border-warning ps-2">
                        <strong>Reflexão:</strong> ${part.question}
                    </div>
                `;
            }
            
            partCard.innerHTML = `
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h3 class="card-title mb-0">${part.title}</h3>
                    </div>
                    <div class="card-body collapsed">
                        ${part.objective ? `<p class="objective-text">${part.objective}</p>` : ''}
                        ${part.html}
                        ${reflectionHtml}
                    </div>
                    <div class="card-footer">
                        <div class="mb-2">${badgesHtml}</div>
                        <button class="btn btn-outline-success expand-button" onclick="toggleCardExpansion('card-part-${index + 1}')">Mostrar mais</button>
                    </div>
                </div>
            `;
            cardsContainer.appendChild(partCard);
        });
        
        // Encontrar e criar o card de conclusão
        const conclusionSection = Array.from(sections).find(s => 
            s.textContent.toLowerCase().includes('conclusão'));
        
        if (conclusionSection) {
            let conclusionHtml = conclusionSection.outerHTML;
            let nextNode = conclusionSection.nextElementSibling;
            while (nextNode) {
                conclusionHtml += nextNode.outerHTML;
                nextNode = nextNode.nextElementSibling;
            }
            
            const conclusionCard = document.createElement('div');
            conclusionCard.className = 'chunk-card conclusion-card';
            conclusionCard.id = 'card-conclusion';
            conclusionCard.innerHTML = `
                <div class="card h-100">
                    <div class="card-header bg-purple text-white">
                        <h3 class="card-title mb-0">Conclusão</h3>
                    </div>
                    <div class="card-body collapsed">
                        ${conclusionHtml}
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-outline-purple expand-button" onclick="toggleCardExpansion('card-conclusion')">Mostrar mais</button>
                    </div>
                </div>
            `;
            cardsContainer.appendChild(conclusionCard);
        }
    }
    
    function createTableOfContents() {
        const toc = document.querySelector('#table-of-contents .toc-container');
        if (!toc) return;
        
        // Use the cards we've created as the basis for the TOC
        const introCard = document.getElementById('card-intro');
        const partCards = document.querySelectorAll('.chunk-card:not(#card-intro):not(#card-conclusion)');
        const conclusionCard = document.getElementById('card-conclusion');
        
        if (introCard) {
            const introTitle = introCard.querySelector('.card-title').textContent;
            const titleLink = document.createElement('a');
            titleLink.href = '#card-intro';
            titleLink.className = 'toc-section d-block fw-bold text-info mb-2';
            titleLink.textContent = introTitle;
            toc.appendChild(titleLink);
            
            // Add subsections if we want
            const introSubsections = introCard.querySelectorAll('h2');
            if (introSubsections.length > 0) {
                const subList = document.createElement('ul');
                subList.className = 'list-unstyled ms-3 mb-3';
                
                introSubsections.forEach((heading, index) => {
                    if (!heading.id) heading.id = 'intro-section-' + index;
                    const item = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = '#' + heading.id;
                    link.className = 'text-decoration-none';
                    link.textContent = heading.textContent;
                    item.appendChild(link);
                    subList.appendChild(item);
                });
                
                toc.appendChild(subList);
            }
        }
        
        // Add parts section
        if (partCards.length > 0) {
            const partsHeader = document.createElement('div');
            partsHeader.className = 'fw-bold text-success mb-2';
            partsHeader.textContent = 'Chunks de Estudo';
            toc.appendChild(partsHeader);
            
            const partsList = document.createElement('ul');
            partsList.className = 'list-unstyled ms-3 mb-3';
            
            // Add each part
            partCards.forEach((card, index) => {
                const title = card.querySelector('.card-title').textContent;
                const item = document.createElement('li');
                const link = document.createElement('a');
                link.href = '#card-part-' + (index + 1);
                link.className = 'text-decoration-none border-start border-success ps-2';
                link.textContent = title;
                item.appendChild(link);
                partsList.appendChild(item);
            });
            
            toc.appendChild(partsList);
        }
        
        // Add conclusion
        if (conclusionCard) {
            const conclusionHeader = document.createElement('div');
            conclusionHeader.className = 'fw-bold text-purple mb-2';
            conclusionHeader.textContent = 'Conclusão';
            toc.appendChild(conclusionHeader);
            
            const link = document.createElement('a');
            link.href = '#card-conclusion';
            link.className = 'text-decoration-none ms-3';
            link.textContent = 'Conclusão e Fechamento';
            toc.appendChild(link);
        }
    }
    
    // Inicializar o Masonry para layout em grade
    function initMasonry() {
        // Inicializa o Masonry com opções
        window.msnry = new Masonry('#cards-container', {
            itemSelector: '.chunk-card',
            columnWidth: '.chunk-card',
            percentPosition: true,
            gutter: 20
        });
        
        // Atualizar layout do Masonry quando as imagens carregarem
        window.addEventListener('load', () => {
            window.msnry.layout();
        });
    }
    {% endif %}
    </script>
</body>
</html>
